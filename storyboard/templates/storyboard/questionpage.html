{% extends "storyboard/base.html" %} {% load static %} {% static "" as baseUrl
%} {% block user-info %}
<div
  style="color: white; font-size: 18px; padding-top: 5pt; padding-right: 5pt"
>
  {{user.username}}
</div>
{% endblock %} {% block content %}

<div class="entire-panel">
  <!-- Left Panel -->
  <div class="left-panel">
    <!-- Question Section -->
    <div class="question">
      <!-- Add Question Content Here -->
      <!-- Question 1: A dolphin jumps with an initial velocity of 25 m/s at an angle of 30Â° above the horizontal. The dolphin passes through the center of a hoop before returning to the water. If the dolphin is moving horizontally at the instant it goes through the hoop, how high, H, above the water is the center of the hoop? -->
      {{ question }}
    </div>

    <div class="option-figure">
      <!-- Options Section (Multiple Choice) -->
      <form class="options" method="post" id="questionForm">
        {% csrf_token %}
        <input type="hidden" name="unique_identifier" value="submit_answer" />
        {% for choice in choices_question %}
        <label class="option">
          <input type="radio" name="answer" value="{{ forloop.counter0 }}" />
          <div class="option-value">{{ choice.text }}</div>
        </label>
        {% endfor %}
        <div class="submit-section">
          <button type="submit">Submit</button>
          <div class="see-example-section">
            <button type="button" id="seeExample">See Example</button>
          </div>
        </div>
      </form>
      <div class="figure">
        <img
          src="/static/storyboard/images/{{ question_img_url }}"
          alt="No Image"
        />
      </div>
    </div>

    <!-- Knowledge Components Section -->
    <div class="knowledge-section">
      <h3>Knowledge Components:</h3>

      {% for kc in knowledge_components %}
      <div class="knowledge-stars">
        <div class="knowledge">{{ kc.knowledge }}</div>
        <div class="stars">
          {% for star in kc.stars %}
          <div class="{{ star }}"></div>
          {% endfor %}
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Right Panel -->
  <div class="right-panel">
    <!-- Hint Section -->
    <div class="hint-section">
      <div class="hint-navigation">
        <button id="prevHint">Previous Hint</button>
        <button id="nextHint">Next Hint</button>
      </div>
      <!-- Hint Question Section -->
      <div class="hint">{{ hint }}</div>

      <div class="option-figure">
        <!-- Placeholder for hint options -->
        {% include 'storyboard/hint_options.html' %}
        <!-- End of hint options -->
        {% if hint_img_url %}
        <div class="hint-figure">
          <img
            src="/static/storyboard/images/{{ hint_img_url }}"
            alt="No Image"
          />
        </div>
        {% else %}
        <div class="hint-figure">
          <img src="" alt="No Image" style="display: none" />
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Feedback Section -->
    <h3>Feedback:</h3>
    <div class="feedback-section">{{ feedback|linebreaks|safe }}</div>
  </div>

  <!-- Overlay for 'See Example' -->
  <div id="exampleOverlay" class="overlay" style="display: none">
    <div class="overlay-content">
      {{ example_problem|linebreaks|safe }}
      <button id="closeExample">Close</button>
    </div>
  </div>
</div>

<script>
  // QUESTION FORM
  document.getElementById("questionForm").onsubmit = function (event) {
    event.preventDefault(); // Prevent the form from submitting normally

    const form = event.target;
    const formData = new FormData(form);

    fetch(form.action, {
      method: "POST",
      body: formData,
      headers: {
        "X-CSRFToken": formData.get("csrfmiddlewaretoken"),
      },
    })
      .then((response) => response.json())
      .then((data) => {
        const options = form.querySelectorAll(".option input[type='radio']");

        // Reset all option classes and colors
        options.forEach((input) => {
          input.classList.remove("correct", "incorrect");
        });

        // Highlight the selected option based on correctness
        options.forEach((input) => {
          if (input.value === formData.get("answer")) {
            input.classList.add(data.correct ? "correct" : "incorrect");
          }
        });

        // Update feedback section
        document.querySelector(".feedback-section").textContent = data.feedback;
      })
      .catch((error) => console.error("Error:", error));
  };

  // HINT FORM
  document
    .querySelectorAll('.hint-section .option input[type="radio"]')
    .forEach((input) => {
      input.addEventListener("change", function () {
        const selectedValue = this.value;

        const form = this.closest("form");
        const formData = new FormData(form);
        formData.append("hint_answer", selectedValue);
        formData.append("unique_identifier", "submit_hint"); // To identify hint submissions in your view

        fetch(window.location.href, {
          // or specify a different URL for hint processing
          method: "POST",
          body: formData,
          headers: {
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")
              .value,
          },
        })
          .then((response) => response.json())
          .then((data) => {
            const hintOptions = document.querySelectorAll(
              ".hint-section .option input[type='radio']"
            );

            // Reset all hint option classes
            hintOptions.forEach((input) => {
              input.classList.remove("correct", "incorrect");
            });

            // Highlight based on server response
            hintOptions.forEach((input) => {
              if (input.value === selectedValue) {
                input.classList.add(data.correct ? "correct" : "incorrect");
              }
            });

            // Update feedback from server response
            document.querySelector(".feedback-section").textContent =
              data.feedback;
          })
          .catch((error) => console.error("Error:", error));
      });
    });

  // Add event listeners for hint navigation buttons
  document.getElementById("prevHint").addEventListener("click", function () {
    changeHint(false); // false indicates we want the previous hint
  });

  document.getElementById("nextHint").addEventListener("click", function () {
    changeHint(true); // true indicates we want the next hint
  });

  function changeHint(isNextHint) {
    const formData = new FormData();
    formData.append("unique_identifier", "change_hint");
    formData.append("isNextHint", isNextHint);

    fetch("{% url 'changehint' %}", {
      method: "POST",
      body: formData,
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        // Update the hint content
        document.querySelector(".hint").innerHTML = data.hint_text;

        // Update the hint image if available
        if (data.hint_img_url) {
          const hintFigure = document.querySelector(".hint-figure img");
          hintFigure.src = "/static/storyboard/images/" + data.hint_img_url;
          hintFigure.style.display = "block";
        } else {
          const hintFigure = document.querySelector(".hint-figure img");
          hintFigure.style.display = "none";
        }

        // Update the hint options
        const hintOptionsContainer = document.querySelector(
          ".hint-section .options"
        );
        hintOptionsContainer.innerHTML = data.hint_options_html;

        // Reattach the event listeners for the new hint options
        attachHintOptionListeners();

        // **Add the following line to re-render LaTeX**
        if (window.MathJax) {
          MathJax.typeset();
        }
      })
      .catch((error) => console.error("Error:", error));
  }

  function attachHintOptionListeners() {
    document
      .querySelectorAll('.hint-section .option input[type="radio"]')
      .forEach((input) => {
        input.addEventListener("change", function () {
          const selectedValue = this.value;

          const form = this.closest("form");
          const formData = new FormData(form);
          formData.append("hint_answer", selectedValue);
          formData.append("unique_identifier", "submit_hint");

          fetch(window.location.href, {
            method: "POST",
            body: formData,
            headers: {
              "X-CSRFToken": "{{ csrf_token }}",
            },
          })
            .then((response) => response.json())
            .then((data) => {
              const hintOptions = document.querySelectorAll(
                ".hint-section .option input[type='radio']"
              );

              // Reset all hint option classes
              hintOptions.forEach((input) => {
                input.classList.remove("correct", "incorrect");
              });

              // Highlight based on server response
              hintOptions.forEach((input) => {
                if (input.value === selectedValue) {
                  input.classList.add(data.correct ? "correct" : "incorrect");
                }
              });

              // Update feedback from server response
              document.querySelector(".feedback-section").textContent =
                data.feedback;

              // **Add the following line to re-render LaTeX**
              if (window.MathJax) {
                MathJax.typeset();
              }
            })
            .catch((error) => console.error("Error:", error));
        });
      });

    // **Add the following line to re-render LaTeX after attaching listeners**
    if (window.MathJax) {
      MathJax.typeset();
    }
  }

  // Call the function to attach listeners on page load
  attachHintOptionListeners();

  // Open the overlay when 'See Example' button is clicked
  document.getElementById("seeExample").addEventListener("click", function () {
    document.getElementById("exampleOverlay").style.display = "block";
    if (window.MathJax) {
      MathJax.typeset();
    }
  });

  // Close the overlay when 'Close' button is clicked
  document
    .getElementById("closeExample")
    .addEventListener("click", function () {
      document.getElementById("exampleOverlay").style.display = "none";
    });
</script>

{% endblock %}
